name: Release workflow
on:
  release:
    types: [published]
jobs:
  main:
    name: Build release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - php_version: "5.6"
            composer: "composer-v5.json"
          - php_version: "7.4"
            composer: "composer-v5.json"
          - php_version: "8.0"
            composer: "composer.json"
    env:
      COMPOSER: ${{ matrix.composer }}
    steps:
      -
        uses: actions/checkout@v2
      -
        name: Setup PHP ${{ matrix.php_version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php_version }}
      -
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      -
        run: pip install pre-commit
      -
        uses: ramsey/composer-install@v1
        with:
          composer-options: "--no-dev --optimize-autoloader"
      -
        run: yarn install
      -
        name: Transpile to PHP ${{ matrix.php_version }}
        run: |
          docker run \
          --rm \
          --env PHP_VERSION=${{ matrix.php_version }} \
          -v $(pwd):/project \
          -w /rector \
          rector/rector:latest \
          process \
          --autoload-file=/project/vendor/autoload.php \
          --config /project/rector.php
      -
        run: yarn build
        env:
          NODE_ENV: production
      -
        run: ./remove_unnecessary_files.sh
      -
        run: pre-commit run --all-files || true
      -
        run: |
          zip -r \
          --exclude='data/cache/**' \
          --exclude='data/errors/**' \
          --exclude='data/transactions/**' \
          ${BUILD_NAME} \
          build/ \
          bootstrap/ \
          confidential/ \
          data/ \
          includes/ \
          migrations/ \
          translations/ \
          themes/ \
          vendor/ \
          .htaccess \
          favicon.png \
          index.php \
          README.md
        env:
          BUILD_NAME: build-${{ matrix.php_version }}.zip
      -
        name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
#          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path: ./$BUILD_NAME
          asset_name: $BUILD_NAME
          asset_content_type: application/zip
